window.DVD={Models:{},Collections:{},Views:{},Routers:{},Utl:{},today:new Date("July 31, 2014"),initialize:function(){var a=$("#content");new DVD.Routers.Router({$rootEl:a}),Backbone.history.start()}},DVD.Utl.FilteredCollection=Backbone.Collection.extend({initialize:function(){this._originalModels=this.models,this._filters={}},addFilter:function(a,b){if("function"!=typeof b)throw new Error("filterFunction must be a function");this._filters[a]=b,this.updateFilter()},applyFilters:function(a){for(var b in this._filters)if(this._filters.hasOwnProperty(b)&&!this._filters[b](a))return!1;return!0},clearFilter:function(){this._resetModels(),this._filters={},this.trigger("filtered")},removeFilter:function(a){delete this._filters[a],this.updateFilter()},updateFilter:function(){this._resetModels();var a=Backbone.Collection.prototype.filter.call(this,this.applyFilters.bind(this));this.reset(a),this.trigger("filtered")},_resetModels:function(){this.reset(this._originalModels)}}),DVD.Models.DataPoints=Backbone.Model.extend({parse:function(a){if(a.date&&a.time){var b=a.date+" "+a.time;a.date=new Date(b),delete a.time}return a}}),DVD.Collections.DataPoints=DVD.Utl.FilteredCollection.extend({comparator:"date",model:DVD.Models.DataPoints,url:"data/data_with_locations.min.json",activityHourlyBreakdown:function(){var a=this.groupBy(function(a){var b=new Date(a.get("date"));return b.setMinutes(0),b.setSeconds(0),b.getTime()}),b=[];return _(a).each(function(a,c){var d=0,e=a.length;_(a).each(function(a){d+=parseInt(a.get("activity"),10)}),b.push([c,d/e*100])}),b},clearGender:function(){this.removeFilter("gender")},deviceCount:function(){return this.countBy("device")},genderCount:function(){return this.countBy("gender")},oneGender:function(a){this.addFilter("gender",function(b){return b.get("gender")===a})},withinPastDays:function(a){var b=new Date(DVD.today);b.setDate(DVD.today.getDate()-a),this.addFilter("days",function(a){var c=new Date(a.get("date"));return c.setHours(0),c.setMinutes(0),c.setSeconds(0),c>=b&&c<=DVD.today})},removeLocation:function(){this._locationAccessor="country",this.removeFilter("location")},setUSA:function(){this._locationAccessor="state",this.addFilter("location",function(a){return"USA"===a.get("country")})},locationData:function(){var a=this,b=this.groupBy(function(b){return b.get(a._locationAccessor)});return _(b).reduce(this._reduceToPercents,{})},_locationAccessor:"country",_reduceToPercents:function(a,b,c){var d=b.length,e=0;return _(b).each(function(a){e+=a.get("activity")}),a[c]=e/d,a}}),DVD.Routers.Router=Backbone.Router.extend({routes:{"":"mainContent"},initialize:function(a){this.$rootEl=a.$rootEl},mainContent:function(){DVD.Collections.data_points=new DVD.Collections.DataPoints,DVD.Collections.data_points.fetch();var a=new DVD.Views.MainView({collection:DVD.Collections.data_points});this._swapViews(a)},_swapViews:function(a){this._currentView&&this._currentView.remove(),this._currentViews=a,this.$rootEl.html(a.render().$el)}}),this.JST=this.JST||{},this.JST.line_chart_view=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<div class="right trendlineButton"><button id="trendlineToggle">Add Trendline</button></div>\n<div id="chart"></div>';return __p},this.JST.main_view=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<section id="day_buttons">\n  <ul class="buttons">\n    <li><button id="today">Today</button></li>\n    <li><button id="three_days">3 Days</button></li>\n    <li><button id="seven_days">7 Days</button></li>\n    <li><button id="fifteen_days" class="selected">15 Days</button></li>\n  </ul>\n</section>\n\n<section id="line_chart"></section>\n\n<section id="segments" class="left"></section>\n\n<section id="pie_chart" class="right"></section>\n\n<section id="map_view" class="map_view"></section>';return __p},this.JST.map_view=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<h2>Rate of activity</h2>\n<div>\n  <button id="world_button" class="selected" data-location="world">World</button>\n  <button id="usa_button" data-location="usa">USA</button>\n</div>\n<div id="map" class="map"></div>';return __p},this.JST.segments=function(obj){obj||(obj={});{var __p="";_.escape}with(obj)__p+='<h2>Segments</h2>\n<section>\n  <div><button id="all_button" class="selected">All:</button> <span id="total_count">0</span></div>\n  <div><button id="male_button">Male:</button> <span id="male_count">0</span></div>\n  <div><button id="female_button">Female:</button> <span id="female_count">0</span></div>\n</section>';return __p},DVD.Views.LineChartView=Backbone.View.extend({events:{"click #trendlineToggle":"trendlineToggle"},template:JST.line_chart_view,initialize:function(){this.listenTo(this.collection,"sync",this.createChart),this.listenTo(this.collection,"filtered",this.updateCharts),this.collection.trigger("update")},render:function(){var a=this.template();return this.$el.html(a),this.createChart(),this},_leastSquares:function(a,b){var c=function(a,b){return a+b},d=1*_(a).reduce(c)/a.length,e=1*_(b).reduce(c)/b.length,f=_(a).map(function(a){return Math.pow(a-d,2)});f=_(f).reduce(c);var g=_(b).map(function(a){return Math.pow(a-e,2)});g=_(g).reduce(c);var h=_(a).map(function(a,c){return(a-d)*(b[c]-e)});h=_(h).reduce(c);var i=h/f,j=e-d*i,k=Math.pow(h,2)/(f*g);return[i,j,k]},addTrendLine:function(){var a=this.collection.activityHourlyBreakdown();if(0!==a.length){var b=d3.range(0,a.length),c=[];_(a).each(function(a){c.push(a[1])});var d=this._leastSquares(b,c),e=(b[0],d[0]+d[1]),f=d[0]*b.length+d[1],g=this;this.trendline=this.chart.append("line").attr("class","trend-line").attr("x1",function(){return g.xScale(a[0][0])}).attr("y1",function(){return g.yScale(e)}).attr("x2",function(){return g.xScale(a[a.length-1][0])}).attr("y2",function(){return g.yScale(f)}).attr("stroke","black").attr("stroke-width",1).style("color","blue").attr("transform","translate(20, 0)"),$("#trendlineToggle").text("Remove Trendline")}},createChart:function(){d3.select(this.$("#chart").get(0)).select("svg").remove();var a=this.collection.activityHourlyBreakdown(),b={top:20,right:20,bottom:20,left:20};this.width=this.$el.width()-b.left-b.right,this.height=this.$el.height()-b.top-b.bottom,this.chart=d3.select(this.$("#chart").get(0)).append("svg").attr("width",b.left+this.width+b.right).attr("height",b.top+this.height+b.bottom).append("g").attr("transform","translate("+b.left+","+b.top+")");var c=_(a).map(function(a){return a[0]});this.xScale=d3.time.scale().domain(d3.extent(c)).range([0,this.width]);var d=d3.svg.axis().scale(this.xScale).orient("bottom");this.yScale=d3.scale.linear().domain([100,0]).range([0,this.height]);var e=d3.svg.axis().scale(this.yScale).orient("left"),f=this;this.line=d3.svg.line().x(function(a){return f.xScale(a[0])}).y(function(a){return f.yScale(a[1])}),this.chart.append("path").datum(a).attr("class","mean-line line").attr("transform","translate(20, 0)").attr("d",this.line),this.chart.append("g").attr("class","x axis").attr("transform","translate(20,"+this.height+")").call(d),this.chart.append("g").attr("class","y axis").attr("transform","translate(20, 0)").call(e)},removeTrendLine:function(){this.trendline.remove(),this.trendline=void 0,$("#trendlineToggle").text("Add Trendline")},trendlineToggle:function(){void 0===this.trendline?this.addTrendLine():this.removeTrendLine()},updateCharts:function(){this.createChart(),void 0!==this.trendline&&this.addTrendLine()}}),DVD.Views.MainView=Backbone.View.extend({events:{"click #day_buttons #today":"today","click #day_buttons #three_days":"threeDays","click #day_buttons #seven_days":"sevenDays","click #day_buttons #fifteen_days":"fifteenDays"},template:JST.main_view,initialize:function(){this.fifteenDays=this.updateForNumDays.bind(this,14),this.sevenDays=this.updateForNumDays.bind(this,6),this.threeDays=this.updateForNumDays.bind(this,2),this.today=this.updateForNumDays.bind(this,0)},render:function(){var a=this.template();return this.$el.html(a),this.renderSegements(),this.renderLineChart(),this.renderPieChart(),this.renderMap(),this},renderSegements:function(){this.segments=new DVD.Views.SegmentsView({collection:this.collection}),this.$("#segments").html(this.segments.render().$el)},renderLineChart:function(){var a=this.$("#line_chart").css({height:"300px",width:"960px"});this.lineChart=new DVD.Views.LineChartView({collection:this.collection,el:a.get(0)}),this.lineChart.render()},renderMap:function(){var a=this.$("#map_view");this.map=new DVD.Views.MapView({collection:this.collection,el:a.get(0)}),this.map.render()},renderPieChart:function(){var a=this.$("#pie_chart").css({height:"430px",width:"430px"});this.pieChart=new DVD.Views.PieChartView({collection:this.collection,el:a.get(0)}),this.pieChart.render()},clearUpdates:function(){this.collection.clearGender()},updateForNumDays:function(a,b){this.collection.withinPastDays(a),this.$("#day_buttons button").removeClass("selected"),this.$(b.target).addClass("selected")}}),DVD.Views.MapView=Backbone.View.extend({events:{"click #usa_button":"updateLocation","click #world_button":"updateLocation"},template:JST.map_view,initialize:function(){this.listenTo(this.collection,"sync filtered",this.createMap.bind(this)),this.location="world"},render:function(){var a=this.template();return this.$el.html(a),this},createMap:function(){this.$("#map").html("");var a=this.collection.locationData(),b=this.createMapData(a);this.map=new Datamap({scope:this.location,element:this.$("#map").get(0),fills:b.fills,data:b.data,geographyConfig:{popupOnHover:!0,popupTemplate:function(a,b){var c='<div class="hoverinfo"><strong>'+a.properties.name+"</strong>";return null!==b&&void 0!==b&&(c+=" - "+(100*b.count).toFixed(2)+"%</div>"),c}}})},createMapData:function(a){var b=_(a).map(function(a){return a}),c=d3.scale.linear().domain(d3.extent(b)).range(["#FFFFFF","#000000"]);return _(a).reduce(function(a,b,d){return a.fills[d]=c(b),a.data[d]={fillKey:d,count:b},a},{fills:{defaultFill:"blue"},data:{}})},updateLocation:function(a){var b=$(a.target),c=b.data("location");if(this.map.options.scope!==c)if(this.$("#usa_button, #world_button").removeClass("selected"),b.addClass("selected"),this.location=c,"usa"===c)this.collection.setUSA();else{if("world"!==c)throw new Error("location must be either 'usa' or 'world'");this.collection.removeLocation()}}}),DVD.Views.PieChartView=Backbone.View.extend({initialize:function(){this.listenTo(this.collection,"sync filtered",this.createChart)},render:function(){var a=$("<h2></h2>").text("Devices");return this.$el.append(a),this.createChart(),this},createChart:function(){d3.select(this.el).select("svg").remove();var a=this.collection.deviceCount(),b=_(a).map(function(a,b){return[b,a]}),c={top:20,right:20,bottom:100,left:20};this.width=this.$el.width()-c.left-c.right,this.height=this.$el.height()-c.top-c.bottom,this.radius=Math.min(this.width,this.height)/2;var d=["#98abc5","#8a89a6","#7b6888"],e=d3.svg.arc().outerRadius(this.radius).innerRadius(0),f=d3.layout.pie().value(function(a){return a[1]});this.chart=d3.select(this.el).append("svg").attr("width",c.left+this.width+c.right).attr("height",c.top+this.height+c.bottom).append("g").attr("transform","translate("+(this.width/2+c.left)+","+(this.height/2+c.top)+")");var g=this.chart.selectAll(".arc").data(f(b)).enter().append("g").attr("class","arc");g.append("path").attr("d",e).style("fill",function(a,b){return d[b]}),g.append("text").attr("transform",function(a){return"translate("+e.centroid(a)+")"}).attr("dy",".35em").style("text-anchor","middle").text(function(a){return a.data[0]})}}),DVD.Views.SegmentsView=Backbone.View.extend({template:JST.segments,events:{"click #all_button":"allEventCallback","click #male_button":"maleEventCallback","click #female_button":"femaleEventCallback"},initialize:function(){this.listenTo(this.collection,"sync filtered",this.updateCount)},allEventCallback:function(){this.collection.clearGender(),this.clearButtonClasses(),$("#all_button").addClass("selected")},clearButtonClasses:function(){$("#all_button, #male_button, #female_button").removeClass("selected")},femaleEventCallback:function(){this.collection.oneGender("female"),this.clearButtonClasses(),$("#female_button").addClass("selected")},maleEventCallback:function(){this.collection.oneGender("male"),this.clearButtonClasses(),$("#male_button").addClass("selected")},render:function(){var a=this.template();return this.$el.html(a),this.updateCount(),this},updateCount:function(){var a=this.collection.genderCount(),b=a.male||0,c=a.female||0;this.$("#total_count").text(b+c),this.$("#male_count").text(b),this.$("#female_count").text(c)}});
//# sourceMappingURL=source.min.js.map